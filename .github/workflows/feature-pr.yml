# åŠŸèƒ½åˆ†æ”¯æ¨é€æ™‚è‡ªå‹•å‰µå»º PR ä¸¦åŸ·è¡Œ CI æª¢æŸ¥
name: Feature Branch PR & CI

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'
      - 'refactor/**'
      - 'chore/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  setup-pr:
    name: è¨­ç½® Pull Request
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.get-pr.outputs.pr_number }}
      pr-exists: ${{ steps.get-pr.outputs.pr_exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ PR
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              base: 'develop',
              state: 'open'
            });

            if (pulls.length > 0) {
              // PR å·²å­˜åœ¨
              console.log(`âœ… æ‰¾åˆ°ç¾æœ‰ PR: #${pulls[0].number}`);
              core.setOutput('pr_number', pulls[0].number);
              core.setOutput('pr_exists', 'true');
            } else {
              // éœ€è¦å‰µå»ºæ–° PR
              console.log('ğŸ“ éœ€è¦å‰µå»ºæ–°çš„ PR');
              core.setOutput('pr_exists', 'false');
            }

      - name: å‰µå»ºæ–°çš„ Pull Request
        id: create-pr
        if: steps.get-pr.outputs.pr_exists == 'false'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: develop
          pr_title: 'ğŸš€ ${{ github.ref_name }} â†’ develop'
          pr_body: |
            ## åŠŸèƒ½åˆ†æ”¯ Pull Request

            **ä¾†æºåˆ†æ”¯ï¼š** `${{ github.ref_name }}`  
            **ç›®æ¨™åˆ†æ”¯ï¼š** `develop`  
            **å»ºç«‹æ™‚é–“ï¼š** ${{ github.event.head_commit.timestamp }}

            ### è®Šæ›´å…§å®¹
            - ${{ github.event.head_commit.message }}

            ### æª¢æŸ¥é …ç›®
            - [ ] Lint æª¢æŸ¥
            - [ ] æ¸¬è©¦é€šé
            - [ ] ç¨‹å¼ç¢¼å¯©æŸ¥å®Œæˆ

            ---
            ğŸ¤– æ­¤ PR é€šéæ‰€æœ‰æª¢æŸ¥å¾Œå°‡è‡ªå‹•åˆä½µåˆ° develop åˆ†æ”¯
          pr_label: 'feature'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¨­ç½®æ–°å‰µå»ºçš„ PR ç·¨è™Ÿ
        if: steps.get-pr.outputs.pr_exists == 'false' && steps.create-pr.outputs.pr_number
        run: echo "pr_number=${{ steps.create-pr.outputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: é¡¯ç¤º PR è³‡è¨Š (é™¤éŒ¯ç”¨)
        run: |
          echo "ğŸ” PR è³‡è¨Šï¼š"
          echo "  - PR æ˜¯å¦å·²å­˜åœ¨: ${{ steps.get-pr.outputs.pr_exists }}"
          echo "  - PR ç·¨è™Ÿ: ${{ steps.get-pr.outputs.pr_number }}"
          echo "  - åˆ†æ”¯åç¨±: ${{ github.ref_name }}"

  ci-checks:
    name: CI æª¢æŸ¥ (Lint & Test)
    runs-on: ubuntu-latest
    needs: setup-pr
    # ğŸ”§ ä¿®æ”¹æ¢ä»¶ï¼šåªè¦æœ‰ PR å°±åŸ·è¡Œï¼ˆä¸ç®¡æ˜¯æ–°å»ºé‚„æ˜¯ç¾æœ‰çš„ï¼‰

    # ğŸ”§ æ–°å¢ PostgreSQL æœå‹™
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Lint
        run: |
          echo "ğŸ” åŸ·è¡Œ Lint æª¢æŸ¥..."
          npm run lint
          echo "âœ… Lint æª¢æŸ¥é€šé"

      # ğŸ”§ ä¿®æ”¹æ¸¬è©¦æ­¥é©Ÿï¼Œä½¿ç”¨æ‚¨æ‡‰ç”¨ç¨‹å¼å¯¦éš›çš„ç’°å¢ƒè®Šæ•¸
      - name: é¡¯ç¤ºç’°å¢ƒè³‡è¨Š (é™¤éŒ¯ç”¨)
        run: |
          echo "ğŸ” ç’°å¢ƒè³‡è¨Šï¼š"
          echo "  - Node.js ç‰ˆæœ¬: $(node --version)"
          echo "  - NPM ç‰ˆæœ¬: $(npm --version)"
          echo "  - NODE_ENV: $NODE_ENV"
          echo "  - DB_HOST: $DB_HOST"
          echo "  - DB_USERNAME: $DB_USERNAME"
          echo "  - DB_DATABASE: $DB_DATABASE"
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          DB_DATABASE: test_db
          DB_SYNCHRONIZE: true
          DB_ENABLE_SSL: false

      - name: Run Tests
        run: |
          echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
          npm test
          echo "âœ… æ¸¬è©¦é€šé"
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          DB_DATABASE: test_db
          DB_SYNCHRONIZE: true
          DB_ENABLE_SSL: false
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test_jwt_secret_for_ci' }}
          PORT: 3001

      - name: Run Build Test
        run: |
          echo "ğŸ—ï¸ åŸ·è¡Œå»ºç½®æ¸¬è©¦..."
          npm run build
          echo "âœ… å»ºç½®æˆåŠŸ"
        env:
          NODE_ENV: production
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          DB_DATABASE: test_db
          DB_SYNCHRONIZE: false
          DB_ENABLE_SSL: false
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test_jwt_secret_for_ci' }}

      - name: Comment PR Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.setup-pr.outputs.pr-number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… CI æª¢æŸ¥é€šé
              
              æ‰€æœ‰æª¢æŸ¥é …ç›®éƒ½å·²é€šéï¼š
              - âœ… Lint æª¢æŸ¥
              - âœ… æ¸¬è©¦åŸ·è¡Œ (åŒ…å«è³‡æ–™åº«æ¸¬è©¦)
              - âœ… å»ºç½®æ¸¬è©¦
              
              ğŸ‰ æº–å‚™è‡ªå‹•åˆä½µåˆ° develop åˆ†æ”¯ï¼
              
              ---
              ğŸ¤– ç”± GitHub Actions è‡ªå‹•æª¢æŸ¥`
            });

      - name: Comment PR Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.setup-pr.outputs.pr-number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ CI æª¢æŸ¥å¤±æ•—
              
              è«‹æª¢æŸ¥ä¸¦ä¿®å¾©ä»¥ä¸‹å•é¡Œï¼š
              - ğŸ” æª¢æŸ¥ Lint éŒ¯èª¤
              - ğŸ§ª ç¢ºèªæ¸¬è©¦æ˜¯å¦é€šé (åŒ…å«è³‡æ–™åº«é€£æ¥)
              - ğŸ—ï¸ é©—è­‰å»ºç½®æ˜¯å¦æˆåŠŸ
              
              ä¿®å¾©å¾Œæ¨é€æ–°çš„ commit å°‡é‡æ–°è§¸ç™¼æª¢æŸ¥ã€‚
              
              **å¸¸è¦‹å•é¡Œæ’é™¤ï¼š**
              - è³‡æ–™åº«é€£æ¥éŒ¯èª¤ï¼šæª¢æŸ¥æ¸¬è©¦ä¸­çš„è³‡æ–™åº«æŸ¥è©¢èªæ³•
              - ç’°å¢ƒè®Šæ•¸å•é¡Œï¼šç¢ºèª .env.test é…ç½®æ­£ç¢º
              
              ---
              ğŸ¤– ç”± GitHub Actions è‡ªå‹•æª¢æŸ¥`
            });

  auto-merge:
    name: è‡ªå‹•åˆä½µåˆ° develop
    runs-on: ubuntu-latest
    needs: [setup-pr, ci-checks]
    if: needs.ci-checks.result == 'success'

    steps:
      - name: Auto merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }} # ä½¿ç”¨ PAT ä»£æ›¿ GITHUB_TOKEN
          script: |
            const prNumber = ${{ needs.setup-pr.outputs.pr-number }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (pr.mergeable && pr.state === 'open') {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                commit_title: `Auto merge: ${pr.title}`,
                commit_message: `è‡ªå‹•åˆä½µ ${pr.head.ref} åˆ° develop\n\nâœ… é€šéæ‰€æœ‰ CI æª¢æŸ¥å¾Œè‡ªå‹•åˆä½µ\n- Lint æª¢æŸ¥é€šé\n- æ¸¬è©¦åŸ·è¡ŒæˆåŠŸ\n- å»ºç½®æ¸¬è©¦å®Œæˆ`,
                merge_method: 'squash'
              });
              
              console.log('âœ… æˆåŠŸè‡ªå‹•åˆä½µåˆ° develop åˆ†æ”¯');
            }

      - name: Trigger develop-to-main workflow
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'develop-to-main.yml',
              ref: 'develop'
            });
            console.log('âœ… å·²è§¸ç™¼ develop-to-main å·¥ä½œæµç¨‹');
